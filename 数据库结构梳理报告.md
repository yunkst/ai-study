# AI学习系统数据库结构梳理报告

## 概述

AI学习系统采用关系型数据库设计，包含7个核心数据表，支持用户管理、学科管理、题库管理、题目管理、学习记录和AI对话等功能。数据库设计遵循第三范式，确保数据的完整性和一致性。

## 数据表结构

### 1. 用户表 (users)

**用途**: 存储系统用户的基本信息和认证数据

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 用户唯一标识 |
| username | String(50) | UNIQUE, NOT NULL | 用户名 |
| email | String(100) | UNIQUE, NOT NULL | 邮箱地址 |
| hashed_password | String(255) | NOT NULL | 加密密码 |
| is_active | Boolean | DEFAULT TRUE | 用户状态 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |
| updated_at | DateTime | ON UPDATE NOW() | 更新时间 |

**关联关系**:
- 一对多 → user_answers (用户答题记录)
- 一对多 → study_records (学习记录)
- 一对多 → ai_conversations (AI对话记录)

### 2. 学科表 (subjects)

**用途**: 存储学科分类信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 学科唯一标识 |
| name | String(100) | NOT NULL | 学科名称 |
| description | Text | NULL | 学科描述 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |

**关联关系**:
- 一对多 → questions (题目)
- 一对多 → question_banks (题库)
- 一对多 → study_records (学习记录)

### 3. 题库表 (question_banks)

**用途**: 存储题库信息和导入状态

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 题库唯一标识 |
| subject_id | Integer | FK, NULL | 关联学科ID |
| name | String(200) | NOT NULL | 题库名称 |
| description | Text | NULL | 题库描述 |
| file_name | String(255) | NOT NULL | 原始文件名 |
| total_questions | Integer | DEFAULT 0 | 总题目数 |
| imported_questions | Integer | DEFAULT 0 | 已导入题目数 |
| status | String(20) | DEFAULT 'pending' | 导入状态 |
| error_message | Text | NULL | 错误信息 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |
| updated_at | DateTime | ON UPDATE NOW() | 更新时间 |

**状态枚举**: pending, processing, completed, failed

**关联关系**:
- 多对一 ← subjects (学科)
- 一对多 → questions (题目)

### 4. 题目表 (questions)

**用途**: 存储具体的题目内容和答案

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 题目唯一标识 |
| subject_id | Integer | FK, NOT NULL | 关联学科ID |
| question_bank_id | Integer | FK, NULL | 关联题库ID |
| title | Text | NOT NULL | 题目标题 |
| content | Text | NOT NULL | 题目内容 |
| question_type | String(20) | NOT NULL | 题目类型 |
| options | JSON | NULL | 选择题选项 |
| correct_answer | Text | NOT NULL | 正确答案 |
| explanation | Text | NULL | 答案解析 |
| difficulty | Integer | DEFAULT 1 | 难度等级(1-5) |
| tags | JSON | NULL | 题目标签 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |
| updated_at | DateTime | ON UPDATE NOW() | 更新时间 |

**题目类型枚举**: single_choice, multiple_choice, essay

**关联关系**:
- 多对一 ← subjects (学科)
- 多对一 ← question_banks (题库)
- 一对多 → user_answers (用户答案)
- 一对多 → ai_conversations (AI对话)

### 5. 用户答案表 (user_answers)

**用途**: 记录用户的答题历史和结果

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 记录唯一标识 |
| user_id | Integer | FK, NOT NULL | 关联用户ID |
| question_id | Integer | FK, NOT NULL | 关联题目ID |
| user_answer | Text | NOT NULL | 用户答案 |
| is_correct | Boolean | NULL | 是否正确 |
| time_spent | Integer | NULL | 答题用时(秒) |
| created_at | DateTime | DEFAULT NOW() | 答题时间 |

**关联关系**:
- 多对一 ← users (用户)
- 多对一 ← questions (题目)

### 6. 学习记录表 (study_records)

**用途**: 统计用户的学习数据和进度

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 记录唯一标识 |
| user_id | Integer | FK, NOT NULL | 关联用户ID |
| subject_id | Integer | FK, NULL | 关联学科ID |
| study_date | DateTime | DEFAULT NOW() | 学习日期 |
| questions_answered | Integer | DEFAULT 0 | 答题数量 |
| correct_answers | Integer | DEFAULT 0 | 正确答题数 |
| study_time | Integer | DEFAULT 0 | 学习时长(分钟) |

**关联关系**:
- 多对一 ← users (用户)
- 多对一 ← subjects (学科)

### 7. AI对话表 (ai_conversations)

**用途**: 存储用户与AI的对话记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, 自增 | 对话唯一标识 |
| user_id | Integer | FK, NOT NULL | 关联用户ID |
| question_id | Integer | FK, NULL | 关联题目ID |
| user_message | Text | NOT NULL | 用户消息 |
| ai_response | Text | NOT NULL | AI回复 |
| conversation_type | String(50) | NULL | 对话类型 |
| created_at | DateTime | DEFAULT NOW() | 对话时间 |

**对话类型**: explanation, hint, discussion

**关联关系**:
- 多对一 ← users (用户)
- 多对一 ← questions (题目)

## 数据关系图解

```
用户 (User)
├── 1:N → 用户答案 (UserAnswer)
│   └── N:1 → 题目 (Question)
├── 1:N → 学习记录 (StudyRecord)
│   └── N:1 → 学科 (Subject)
└── 1:N → AI对话 (AIConversation)
    └── N:1 → 题目 (Question)

学科 (Subject)
├── 1:N → 题目 (Question)
├── 1:N → 题库 (QuestionBank)
│   └── 1:N → 题目 (Question)
└── 1:N → 学习记录 (StudyRecord)
```

## 核心业务流程

### 1. 题库导入流程
1. 创建题库记录 (status: pending)
2. 解析上传的JSON文件
3. 更新状态为 processing
4. 批量创建题目记录
5. 更新导入统计和状态 (completed/failed)

### 2. 用户答题流程
1. 获取题目信息 (不含正确答案)
2. 用户提交答案
3. 验证答案正确性
4. 记录答题结果到 user_answers
5. 更新学习记录统计

### 3. AI对话流程
1. 用户发送消息 (可关联特定题目)
2. AI生成回复
3. 保存对话记录到 ai_conversations

## 数据完整性保障

### 1. 外键约束
- 所有关联表都设置了外键约束
- 确保数据引用的完整性
- 防止孤立数据的产生

### 2. 唯一性约束
- 用户名和邮箱的唯一性
- 防止重复注册

### 3. 非空约束
- 关键字段设置非空约束
- 确保核心数据的完整性

### 4. 默认值设置
- 时间戳字段自动设置
- 状态字段有合理默认值
- 计数字段默认为0

## 性能优化建议

### 1. 索引策略
- 主键自动建立聚集索引
- 外键字段建立非聚集索引
- 经常查询的字段(如username, email)建立索引
- 复合查询建立组合索引

### 2. 查询优化
- 使用JOIN代替子查询
- 避免SELECT *，只查询需要的字段
- 合理使用分页查询
- 对大表进行分区

### 3. 数据归档
- 定期归档历史答题记录
- 清理过期的AI对话记录
- 保持活跃数据的查询性能

## 扩展性考虑

### 1. 水平扩展
- 可按用户ID进行分库分表
- 题目数据可按学科分库
- 历史数据可按时间分表

### 2. 功能扩展
- 支持题目版本管理
- 增加题目难度自适应
- 支持多媒体题目内容
- 增加学习路径推荐

### 3. 数据分析
- 用户学习行为分析
- 题目质量评估
- 学习效果统计
- AI对话质量监控

## 总结

该数据库设计具有以下特点：

1. **结构清晰**: 7个核心表覆盖了学习系统的主要功能
2. **关系合理**: 外键关系确保了数据的一致性
3. **扩展性好**: 支持多种题目类型和学科分类
4. **性能考虑**: 合理的索引和约束设计
5. **业务完整**: 覆盖了用户管理、内容管理、学习跟踪等核心业务

数据库设计为AI学习系统提供了稳定可靠的数据存储基础，支持系统的各项核心功能，并为未来的功能扩展预留了空间。