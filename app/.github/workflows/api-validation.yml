name: APIè§„èŒƒéªŒè¯

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lib/**/*.dart'
      - 'assets/openapi.json'
      - '.github/workflows/api-validation.yml'

jobs:
  api-validation:
    name: Flutter APIè§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: æ£€æŸ¥OpenAPIæ–‡æ¡£
      run: |
        if [ ! -f "assets/openapi.json" ]; then
          echo "âŒ OpenAPIæ–‡æ¡£ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… OpenAPIæ–‡æ¡£å­˜åœ¨"
        
    - name: è¿è¡ŒAPIè§„èŒƒæ£€æŸ¥
      run: |
        echo "ğŸ” å¼€å§‹APIè§„èŒƒæ£€æŸ¥..."
        dart run lib/tools/api_analyzer_cli.dart --output api_analysis_report.txt -v
        
    - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-analysis-report
        path: api_analysis_report.txt
        retention-days: 30
        
    - name: æ£€æŸ¥åˆ†æç»“æœ
      run: |
        if [ -f "api_analysis_report.txt" ]; then
          echo "ğŸ“‹ APIåˆ†ææŠ¥å‘Š:"
          cat api_analysis_report.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¿è§„é—®é¢˜
          if grep -q "å‘ç°.*ä¸ªé—®é¢˜" api_analysis_report.txt; then
            echo "âŒ å‘ç°APIè§„èŒƒè¿è§„é—®é¢˜"
            exit 1
          fi
        fi
        echo "âœ… APIè§„èŒƒæ£€æŸ¥é€šè¿‡"
        
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: api-validation
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: dart format --set-exit-if-changed .
      
    - name: é™æ€åˆ†æ
      run: flutter analyze
      
    - name: è¿è¡Œæµ‹è¯•
      run: flutter test
      
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ‰«ææ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ‰«ææ•æ„Ÿä¿¡æ¯..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„APIå¯†é’¥
        if grep -r -i "api[_-]key\|secret\|password\|token" lib/ --include="*.dart" | grep -v "// TODO\|// FIXME"; then
          echo "âŒ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„URL
        if grep -r "http://\|https://" lib/ --include="*.dart" | grep -v "localhost\|127.0.0.1\|example.com"; then
          echo "âš ï¸  å‘ç°ç¡¬ç¼–ç çš„URLï¼Œè¯·ç¡®ä¿ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯"
        fi
        
        echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
        
  notify:
    name: é€šçŸ¥ç»“æœ
    runs-on: ubuntu-latest
    needs: [api-validation, code-quality]
    if: always()
    
    steps:
    - name: æ£€æŸ¥ç»“æœ
      run: |
        if [ "${{ needs.api-validation.result }}" = "success" ] && [ "${{ needs.code-quality.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼"
        else
          echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          exit 1
        fi